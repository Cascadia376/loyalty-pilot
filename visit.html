<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enter Below</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Source Sans 3', sans-serif;
      background-color: #fff;
      color: #111;
      padding: 2rem 1.5rem;
      max-width: 500px;
      margin: auto;
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 2rem;
      color: #339999;
      text-align: center;
      font-weight: 600;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    label {
      font-weight: 600;
      font-size: 1rem;
    }

    input[type="text"],
    input[type="email"] {
      width: 100%;
      border: none;
      border-bottom: 2px solid #ccc;
      font-size: 1rem;
      padding: 0.4rem 0;
      background: transparent;
      color: #111;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      font-weight: 500;
    }

    input[type="checkbox"] {
      accent-color: #339999;
      width: 1.1rem;
      height: 1.1rem;
      margin-right: 0.5rem;
    }

    button {
      background-color: #339999;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.85rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h1 id="greeting">Enter Below!</h1>

  <form id="profileForm" class="hidden">
    <div>
      <label for="firstName">First Name</label>
      <input id="firstName" name="firstName" type="text" required />
    </div>

    <div>
      <label for="lastName">Last Name</label>
      <input id="lastName" name="lastName" type="text" required />
    </div>

    <div>
      <label for="email">Email</label>
      <input id="email" name="email" type="email" required />
    </div>

    <div class="checkbox-wrapper">
      <input id="optIn" name="optIn" type="checkbox" checked />
      <label for="optIn">Yes, I want to receive emails</label>
    </div>

    <button type="submit">Submit</button>
  </form>

  <script>
    (async function () {
      const webhook = "https://hooks.zapier.com/hooks/catch/6984728/uo78v01/";
      const uuid = localStorage.getItem("visitUUID") || (() => {
        const id = crypto.randomUUID();
        localStorage.setItem("visitUUID", id);
        return id;
      })();

      // Detect store from URL param early
      let store = "unknown";
      const params = new URLSearchParams(window.location.search);
      if (params.has("store")) {
        store = params.get("store").toLowerCase();
        localStorage.setItem("storeName", store);
      } else {
        const cached = localStorage.getItem("storeName");
        if (cached) store = cached;
      }

      let visitCount = parseInt(localStorage.getItem("visitCount") || "0");
      const profileData = JSON.parse(localStorage.getItem("profileData") || "{}");
      const greeting = document.getElementById("greeting");
      const form = document.getElementById("profileForm");

      if (profileData.email) {
        visitCount++;
        localStorage.setItem("visitCount", visitCount);
        greeting.innerText = `Welcome back, ${profileData.firstName}!`;
        logToZapier(profileData);
      } else {
        form.classList.remove("hidden");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          firstName: form.firstName.value.trim(),
          lastName: form.lastName.value.trim(),
          email: form.email.value.trim(),
          optIn: form.optIn.checked
        };
        localStorage.setItem("profileData", JSON.stringify(data));
        visitCount++;
        localStorage.setItem("visitCount", visitCount);
        greeting.innerText = `Thanks, ${data.firstName}!`;
        form.classList.add("hidden");
        logToZapier(data);
      });

      function logToZapier(profile) {
        const payload = {
          uuid,
          email: profile.email,
          firstName: profile.firstName,
          lastName: profile.lastName,
          optIn: profile.optIn,
          store,
          timestamp: new Date().toISOString(),
          visitCount
        };
        fetch(webhook, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      }
    })();
  </script>
</body>
</html>
