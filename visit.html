<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Thanks for Visiting</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Source Sans 3', sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      text-align: center;
      background-color: #f8fafa;
      color: #333;
    }

    #greeting {
      font-size: 1.75rem;
      margin-bottom: 2rem;
      color: #339999;
    }

    .iframe-wrapper {
      background: #ffffff;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    iframe {
      width: 100%;
      height: 1200px;
      border: none;
      border-radius: 12px;
    }
  </style>
</head>
<body>

  <h1 id="greeting">Enter Below</h1>

  <div class="iframe-wrapper">
    <iframe src="https://loyalty-pilot.vercel.app/?store=control"></iframe>
  </div>

  <form id="profileForm" class="hidden">
    <label for="firstName">First Name</label>
    <input id="firstName" name="firstName" type="text" required />

    <label for="lastName">Last Name</label>
    <input id="lastName" name="lastName" type="text" required />

    <label for="email">Email</label>
    <input id="email" name="email" type="email" required />

    <label>
      <input id="optIn" name="optIn" type="checkbox" />
      Yes, I want to receive emails
    </label>

    <button type="submit">Submit</button>
  </form>

<script>
(async function() {
  const webhook = "https://hooks.zapier.com/hooks/catch/6984728/uo78v01/";
  const uuid = localStorage.getItem("visitUUID") || (() => {
    const id = crypto.randomUUID();
    localStorage.setItem("visitUUID", id); return id;
  })();

  const store = new URLSearchParams(window.location.search).get("store") || "unknown";
  let visitCount = parseInt(localStorage.getItem('visitCount') || "0");

  const profileCache = JSON.parse(localStorage.getItem("profileData") || "{}");
  const profileForm = document.getElementById('profileForm');
  const greeting = document.getElementById('greeting');

  // If we already have profile info, increment and send visit
  if (profileCache.email) {
    greeting.innerText = "Welcome back, " + profileCache.firstName + "!";
    visitCount += 1;
    localStorage.setItem('visitCount', visitCount);
    logVisit(profileCache);
  } else {
    profileForm.classList.remove('hidden'); // show form to new visitors
  }

  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
      firstName: profileForm.firstName.value.trim(),
      lastName: profileForm.lastName.value.trim(),
      email: profileForm.email.value.trim(),
      optIn: profileForm.optIn.checked
    };
    localStorage.setItem('profileData', JSON.stringify(data));
    visitCount += 1;
    localStorage.setItem('visitCount', visitCount);
    greeting.innerText = "Thanks, " + data.firstName + "!";
    profileForm.classList.add('hidden');

    logVisit(data);
  });

  async function logVisit(profile) {
    const payload = {
      uuid,
      store,
      timestamp: new Date().toISOString(),
      visitCount,
      firstName: profile.firstName || "",
      lastName: profile.lastName || "",
      email: profile.email || "",
      optIn: profile.optIn || false
    };
    fetch(webhook, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).catch(err => console.error(err));
  }
})();
</script>
</body>
</html>
