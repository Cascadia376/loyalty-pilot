<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enter Below</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root { --accent:#339999; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Source Sans 3',sans-serif; background:#fff; color:#111; padding:2rem 1.5rem; max-width:500px; margin:auto; }
    h1 { font-size:1.75rem; margin-bottom:2rem; color:var(--accent); text-align:center; font-weight:600; }
    form { display:flex; flex-direction:column; gap:1.5rem; }
    label { font-weight:600; font-size:1rem; }
    input[type="text"], input[type="email"], select {
      width:100%; border:none; border-bottom:2px solid #ccc; padding:.5rem; font-size:1rem; color:#111; background:transparent; transition:border-color .2s ease;
    }
    input:focus, select:focus { border-color:var(--accent); outline:none; }
    .checkbox-wrapper { display:flex; align-items:center; gap:.5rem; }
    input[type="checkbox"] { accent-color:var(--accent); width:1.1rem; height:1.1rem; }
    button { background:var(--accent); color:#fff; padding:.75rem; border:none; cursor:pointer; font-weight:600; }
    .hidden { display:none; }
    #questionContainer { margin-top:2rem; }
    #questionContainer form { display:flex; flex-direction:column; gap:1rem; }
    #questionContainer form > label:first-of-type { font-size:1.2rem; font-weight:600; color:var(--accent); margin-bottom:.5rem; }
    #questionContainer label { display:flex; align-items:center; font-size:.95rem; font-weight:400; }
    #questionContainer input[type="radio"] { margin-right:.5rem; accent-color:var(--accent); }
    #questionContainer p { font-size:1rem; color:var(--accent); font-weight:600; text-align:center; margin-top:2rem; }
  </style>
</head>
<body>
  <h1 id="greeting">Enter Below!</h1>

  <!-- Profile form (includes store select) -->
  <form id="profileForm" class="hidden">
    <div>
      <label for="firstName">First Name</label>
      <input id="firstName" name="firstName" type="text" required />
    </div>
    <div>
      <label for="lastName">Last Name</label>
      <input id="lastName" name="lastName" type="text" required />
    </div>
    <div>
      <label for="email">Email</label>
      <input id="email" name="email" type="email" required />
    </div>

    <div>
      <label for="favoriteStore">Which store do you visit most often?</label>
      <select id="favoriteStore" name="favoriteStore" required>
        <option value="" disabled selected>Select a store</option>
        <option value="Cascadia Courtenay (Crown Isle)">Cascadia Courtenay (Crown Isle)</option>
        <option value="Cascadia Quadra Village">Cascadia Quadra Village</option>
        <option value="Cascadia Eagle Creek">Cascadia Eagle Creek</option>
        <option value="Cascadia Uptown">Cascadia Uptown</option>
        <option value="Cascadia Langford">Cascadia Langford</option>
        <option value="Cascadia Port Alberni">Cascadia Port Alberni</option>
        <option value="Cascadia Hatley Park">Cascadia Hatley Park</option>
        <option value="Cascadia Caddy Bay">Cascadia Caddy Bay</option>
        <option value="Cascadia Nanoose Bay">Cascadia Nanoose Bay</option>
        <option value="Cascadia Parksville">Cascadia Parksville</option>
        <option value="Cascadia Royal Bay">Cascadia Royal Bay</option>
        <option value="Cascadia Allandale">Cascadia Allandale</option>
      </select>
    </div>

    <div class="checkbox-wrapper">
      <input id="optIn" name="optIn" type="checkbox" checked />
      <label for="optIn">Yes, I want to receive emails</label>
    </div>
    <button type="submit">Submit</button>
  </form>

  <div id="questionContainer" class="hidden"></div>

<script>
  // -------- Giveaway handoff (URL -> postMessage -> localStorage) ----------
  let giveaway = new URLSearchParams(window.location.search).get("giveaway"); // e.g., 'giveaway-mtbgetaway' or 'giveaway-glamping'
  window.addEventListener("message", (event) => {
    if (event?.data && typeof event.data === "object" && event.data.giveaway) {
      giveaway = String(event.data.giveaway);
      localStorage.setItem("giveaway", giveaway);
      console.log("🎁 Received giveaway via postMessage:", giveaway);
    }
  }, false);
  if (!giveaway || !String(giveaway).trim()) {
    giveaway = localStorage.getItem("giveaway") || "Giveaway-Unknown";
  }
  localStorage.setItem("giveaway", giveaway);
  console.log("🎁 Final Giveaway set to:", giveaway);

  (async function () {
    // ✅ Your requested webhook
    const webhook = "https://hooks.zapier.com/hooks/catch/6984728/uo78v01/";
    const ipinfoToken = "3728e29363dc0b";

    // Stable per-device visit UUID
    const uuid = localStorage.getItem("visitUUID") || (() => {
      const id = crypto.randomUUID(); localStorage.setItem("visitUUID", id); return id;
    })();

    // Store options (reused in the rotating question)
    const storeOptions = [
      "Cascadia Courtenay (Crown Isle)",
      "Cascadia Quadra Village",
      "Cascadia Eagle Creek",
      "Cascadia Uptown",
      "Cascadia Langford",
      "Cascadia Port Alberni",
      "Cascadia Hatley Park",
      "Cascadia Caddy Bay",
      "Cascadia Nanoose Bay",
      "Cascadia Parksville",
      "Cascadia Royal Bay",
      "Cascadia Allandale"
    ];

    // Optional: auto-detect store from ?source (kept from your previous flow)
    let store = "unknown";
    const params = new URLSearchParams(window.location.search);
    const sourceUrl = params.get("source");
    if (sourceUrl) {
      try {
        const parsed = new URL(sourceUrl);
        const urlPath = parsed.pathname.toLowerCase();
        if (urlPath.includes("general-in-store-giveaway-kamloops-getaway")) store = "General - Kamloops";
        else if (urlPath.includes("general-in-store-giveaway-sauna"))       store = "General - Sauna";
        else if (urlPath.includes("courtenay-in-store-giveaway-kamloops-getaway")) store = "Courtenay - Kamloops";
        else if (urlPath.includes("courtenay-in-store-giveaway-sauna"))     store = "Courtenay - Sauna";
        else store = "Cascadia Port Alberni";
        localStorage.setItem("storeName", store);
        console.log("🎯 Got store from ?source param:", store);
      } catch (e) {
        console.error("❌ Error parsing ?source:", e);
      }
    } else {
      store = localStorage.getItem("storeName") || "Cascadia Port Alberni";
      console.log("🧩 Using fallback from localStorage:", store);
    }

    function getVancouverTimestamp() {
      const date = new Date();
      const options = { timeZone: "America/Vancouver", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", hour12: false };
      const parts = new Intl.DateTimeFormat("en-CA", options).formatToParts(date);
      const get = (t) => (parts.find(p => p.type === t)?.value || "").toString().padStart(2, "0");
      return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}`;
    }

    let visitCount   = parseInt(localStorage.getItem("visitCount") || "0");
    let questionIndex = parseInt(localStorage.getItem("questionIndex") || "0");

    const profileForm = document.getElementById("profileForm");
    const greeting = document.getElementById("greeting");
    const questionContainer = document.getElementById("questionContainer");
    const profileCache = JSON.parse(localStorage.getItem("profileData") || "{}");

    // Rotating survey (includes store question)
    const questions = [
      { key: "visitFrequency", text: "How often do you visit our stores?", options: ["First time","Once a month","A few times a month","Weekly","More than once a week"] },
      { key: "otherStores",    text: "Do you shop at our other locations?", options: ["Yes","No","Sometimes"] },
      { key: "purchaseType",   text: "What do you usually buy here?", options: ["Beer","Wine","Spirits","Cider/Coolers","Other"] },
      { key: "avgSpend",       text: "About how much do you usually spend per visit?", options: ["Under $20","$20-$50","$50-$100","Over $100"] },
      { key: "favoriteStore",  text: "Which store do you visit most often?", options: storeOptions }
    ];

    if (profileCache.email) {
      greeting.innerText = "Welcome back, " + (profileCache.firstName || "there") + "!";
      await logVisit(profileCache);  // log a “visit” immediately on return
      showQuestion();
    } else {
      profileForm.classList.remove("hidden");
    }

    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        firstName: document.getElementById("firstName").value.trim(),
        lastName:  document.getElementById("lastName").value.trim(),
        email:     document.getElementById("email").value.trim(),
        favoriteStore: document.getElementById("favoriteStore").value,
        optIn:     document.getElementById("optIn").checked
      };
      localStorage.setItem("profileData", JSON.stringify(data));
      greeting.innerText = "Thanks, " + data.firstName + "!";
      profileForm.classList.add("hidden");
      await logVisit(data);           // first profile submit = first logged visit
      showQuestion();
    });

    function showQuestion() {
      const q = questions[questionIndex % questions.length];
      const formHtml = `<form id="progressForm">
          <label>${q.text}</label>
          ${q.options.map(o => `<label><input type="radio" name="answer" value="${o}" required> ${o}</label>`).join("")}
          <button type="submit">Submit</button>
        </form>`;
      questionContainer.innerHTML = formHtml;
      questionContainer.classList.remove("hidden");

      document.getElementById("progressForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) return alert("Please select an answer before continuing.");
        const answer = selected.value;

        const answers = JSON.parse(localStorage.getItem("answers") || "{}");
        answers[q.key] = answer;
        localStorage.setItem("answers", JSON.stringify(answers));

        questionIndex += 1;
        localStorage.setItem("questionIndex", String(questionIndex));

        await logVisit(JSON.parse(localStorage.getItem("profileData") || "{}")); // log after each answer
        questionContainer.innerHTML = "<p>Thank you for your answer!</p>";
      });
    }

    async function logVisit(profile) {
      // Geo cache (12h)
      const geoTimestamp = parseInt(localStorage.getItem("geoTimestamp") || "0");
      const now = Date.now();
      const twelveHours = 12 * 60 * 60 * 1000;
      let location = JSON.parse(localStorage.getItem("geoData") || "null");

      if (!location || (now - geoTimestamp) > twelveHours) {
        try {
          const geoRes = await fetch(`https://ipinfo.io/json?token=${ipinfoToken}`);
          const geoJson = await geoRes.json();
          location = {
            ip:      geoJson.ip      || "Unknown",
            city:    geoJson.city    || "Unknown",
            region:  geoJson.region  || "Unknown",
            country: geoJson.country || "Unknown"
          };
          localStorage.setItem("geoData", JSON.stringify(location));
          localStorage.setItem("geoTimestamp", String(now));
        } catch (e) {
          console.error("🌐 Geolocation fetch failed:", e);
          location = { ip: "", city: "", region: "", country: "" };
        }
      }

      // Increment and persist visit count on every log
      visitCount = (parseInt(localStorage.getItem("visitCount") || "0") + 1);
      localStorage.setItem("visitCount", String(visitCount));

      const answers = JSON.parse(localStorage.getItem("answers") || "{}");

      const payload = {
        UUID: uuid,
        EMAIL:        profile.email || "",
        "FIRST NAME": profile.firstName || "",
        "LAST NAME":  profile.lastName || "",
        "OPT-IN":     !!profile.optIn,

        GIVEAWAY:     localStorage.getItem("giveaway") || "Giveaway-Unknown",
        "CURRENT STORE": answers.favoriteStore || profile.favoriteStore || "",

        TIMESTAMP:    getVancouverTimestamp(),
        "TOTAL VISITS": visitCount,

        IP:      location.ip,
        CITY:    location.city,
        REGION:  location.region,
        COUNTRY: location.country,

        // Survey answers snapshot
        visitFrequency: answers.visitFrequency || "",
        otherStores:    answers.otherStores   || "",
        purchaseType:   answers.purchaseType  || "",
        avgSpend:       answers.avgSpend      || ""
      };

      fetch(webhook, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      console.log("📬 Sent to Zapier:", { giveaway: payload.GIVEAWAY, visits: payload["TOTAL VISITS"], email: payload.EMAIL, ip: payload.IP });
    }
  })();
</script>
</body>
</html>
