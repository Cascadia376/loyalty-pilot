<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enter Below</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root { --accent:#339999; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Source Sans 3',sans-serif; background:#fff; color:#111; padding:2rem 1.5rem; max-width:500px; margin:auto; }
    h1 { font-size:1.75rem; margin-bottom:2rem; color:var(--accent); text-align:center; font-weight:600; }
    form { display:flex; flex-direction:column; gap:1.5rem; }
    label { font-weight:600; font-size:1rem; }
    input[type="text"], input[type="email"], select {
      width:100%; border:none; border-bottom:2px solid #ccc; padding:.5rem; font-size:1rem; color:#111; transition:border-color .2s ease; background:transparent;
    }
    input:focus, select:focus { border-color:var(--accent); outline:none; }
    .checkbox-wrapper { display:flex; align-items:center; gap:.5rem; font-size:.95rem; }
    input[type="checkbox"], input[type="radio"] { accent-color:var(--accent); }
    button { background-color:var(--accent); color:#fff; padding:.85rem; border:none; border-radius:6px; font-weight:700; cursor:pointer; }
    .hidden { display:none; }

    /* Follow-up question area */
    #questionContainer { margin-top:2rem; }
    #questionContainer form { display:flex; flex-direction:column; gap:1rem; }
    #questionContainer form > label:first-of-type { font-size:1.1rem; font-weight:700; color:var(--accent); }
    #questionContainer label { display:flex; align-items:center; gap:.5rem; font-weight:500; }
    #questionContainer p { font-size:1rem; color:var(--accent); font-weight:600; text-align:center; margin-top:1.25rem; }
  </style>
</head>
<body>
  <h1 id="greeting">Enter Below!</h1>

  <!-- Profile / first-time form -->
  <form id="profileForm" class="hidden">
    <div>
      <label for="firstName">First Name</label>
      <input id="firstName" name="firstName" type="text" required />
    </div>
    <div>
      <label for="lastName">Last Name</label>
      <input id="lastName" name="lastName" type="text" required />
    </div>
    <div>
      <label for="email">Email</label>
      <input id="email" name="email" type="email" required />
    </div>

    <!-- Favorite store (added from the other doc) -->
    <div>
      <label for="favoriteStore">Which store do you visit most often?</label>
      <select id="favoriteStore" name="favoriteStore" required>
        <option value="" disabled selected>Select a store</option>
        <option value="Cascadia Courtenay (Crown Isle)">Cascadia Courtenay (Crown Isle)</option>
        <option value="Cascadia Quadra Village">Cascadia Quadra Village</option>
        <option value="Cascadia Eagle Creek">Cascadia Eagle Creek</option>
        <option value="Cascadia Uptown">Cascadia Uptown</option>
        <option value="Cascadia Langford">Cascadia Langford</option>
        <option value="Cascadia Port Alberni">Cascadia Port Alberni</option>
        <option value="Cascadia Hatley Park">Cascadia Hatley Park</option>
        <option value="Cascadia Caddy Bay">Cascadia Caddy Bay</option>
        <option value="Cascadia Nanoose Bay">Cascadia Nanoose Bay</option>
        <option value="Cascadia Parksville">Cascadia Parksville</option>
        <option value="Cascadia Royal Bay">Cascadia Royal Bay</option>
        <option value="Cascadia Allandale">Cascadia Allandale</option>
      </select>
    </div>

    <div class="checkbox-wrapper">
      <input id="optIn" name="optIn" type="checkbox" checked />
      <label for="optIn">Yes, I want to receive emails</label>
    </div>

    <button type="submit">Submit</button>
  </form>

  <!-- Rotating follow-up questions -->
  <div id="questionContainer" class="hidden"></div>

  <script>
    (async function () {
      // ‚úÖ Phase 1 webhook stays the same
      const webhook = "https://hooks.zapier.com/hooks/catch/6984728/uo78v01/"; // Phase 1
      // ‚úÖ Cache a persistent UUID
      const uuid = localStorage.getItem("visitUUID") || (() => {
        const id = crypto.randomUUID();
        localStorage.setItem("visitUUID", id);
        return id;
      })();

      // üß† Derive store/giveaway context from Shopify page URL (?source=...)
      let store = "unknown";
      const params = new URLSearchParams(window.location.search);
      const sourceUrl = params.get("source");

      if (sourceUrl) {
        try {
          const parsed = new URL(sourceUrl);
          const urlPath = parsed.pathname.toLowerCase();

          // Map URL paths to friendly store/giveaway labels (keep your existing mapping logic)
          if (urlPath.includes("general-in-store-giveaway-kamloops-getaway")) {
            store = "General - Kamloops";
          } else if (urlPath.includes("giveaway-mtbgetaway")) {
            store = "General - MTBouchire";
          } else if (urlPath.includes("courtenay-in-store-giveaway-kamloops-getaway")) {
            store = "Courtenay - Kamloops";
          } else if (urlPath.includes("courtenay-in-store-giveaway-sauna")) {
            store = "Courtenay - Sauna";
          } else {
            store = "Port Alberni";
          }

          localStorage.setItem("storeName", store);
          console.log("üéØ Got store from ?source param:", store);
        } catch (e) {
          console.error("‚ùå Error parsing ?source:", e);
        }
      } else {
        store = localStorage.getItem("storeName") || "Port Alberni";
        console.log("üß© Using fallback from localStorage:", store);
      }

      // üìÖ Local (America/Vancouver) timestamp helper
      function getVancouverTimestamp() {
        const date = new Date();
        const options = { timeZone: "America/Vancouver", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", hour12: false };
        const parts = new Intl.DateTimeFormat("en-CA", options).formatToParts(date);
        const get = (type) => parts.find(p => p.type === type)?.value.padStart(2, '0');
        return `${get('year')}-${get('month')}-${get('day')} ${get('hour')}:${get('minute')}`;
      }

      // üåê Lightweight IP/location capture (cached ~12h)
      const ipinfoToken = "3728e29363dc0b";
      async function getGeo() {
        const now = Date.now();
        const cachedAt = parseInt(localStorage.getItem("geoTimestamp") || "0");
        const twelveHours = 12 * 60 * 60 * 1000;
        if (now - cachedAt < twelveHours) {
          try {
            return JSON.parse(localStorage.getItem("geoData") || "null");
          } catch (_) {}
        }
        try {
          const res = await fetch(`https://ipinfo.io/json?token=${ipinfoToken}`);
          const j = await res.json();
          const data = {
            ip: j.ip || "",
            city: j.city || "",
            region: j.region || "",
            country: j.country || ""
          };
          localStorage.setItem("geoData", JSON.stringify(data));
          localStorage.setItem("geoTimestamp", String(now));
          return data;
        } catch (e) {
          console.error("üåê Geolocation fetch failed:", e);
          return { ip: "", city: "", region: "", country: "" };
        }
      }

      // üß© Question set (from your other doc)
      const questions = [
        { key: "visitFrequency", text: "How often do you visit our stores?", options: ["First time","Once a month","A few times a month","Weekly","More than once a week"] },
        { key: "otherStores",    text: "Do you shop at our other locations?", options: ["Yes","No","Sometimes"] },
        { key: "purchaseType",   text: "What do you usually buy here?", options: ["Beer","Wine","Spirits","Cider/Coolers","Other"] },
        { key: "avgSpend",       text: "About how much do you usually spend per visit?", options: ["Under $20","$20-$50","$50-$100","Over $100"] }
      ];

      // üîÅ Progressive state
      let visitCount = parseInt(localStorage.getItem("visitCount") || "0") + 1;
      localStorage.setItem("visitCount", visitCount);
      let questionIndex = parseInt(localStorage.getItem("questionIndex") || "0");

      const profileForm = document.getElementById("profileForm");
      const greeting = document.getElementById("greeting");
      const questionContainer = document.getElementById("questionContainer");
      const profileCache = JSON.parse(localStorage.getItem("profileData") || "{}");

      // First-time vs returning
      if (profileCache.email) {
        greeting.innerText = "Welcome back, " + (profileCache.firstName || "there") + "!";
        await logVisit(profileCache);   // send a visit row on load for returning visitor
        showQuestion();
      } else {
        profileForm.classList.remove("hidden");
      }

      // Submit profile (first-time)
      profileForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          firstName: profileForm.firstName.value.trim(),
          lastName: profileForm.lastName.value.trim(),
          email: profileForm.email.value.trim(),
          favoriteStore: profileForm.favoriteStore.value,
          optIn: profileForm.optIn.checked
        };
        localStorage.setItem("profileData", JSON.stringify(data));
        greeting.innerText = "Thanks, " + data.firstName + "!";
        profileForm.classList.add("hidden");

        // Increment and log visit
        visitCount = parseInt(localStorage.getItem("visitCount") || "0") + 1;
        localStorage.setItem("visitCount", visitCount);
        await logVisit(data);

        showQuestion();
      });

      // Render rotating questions
      function showQuestion() {
        const q = questions[questionIndex % questions.length];
        const formHtml = `<form id="progressForm">
          <label>${q.text}</label>
          ${q.options.map(o => `<label><input type="radio" name="answer" value="${o}" required> ${o}</label>`).join("")}
          <button type="submit">Submit</button>
        </form>`;
        questionContainer.innerHTML = formHtml;
        questionContainer.classList.remove("hidden");

        document.getElementById("progressForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          const selected = document.querySelector('input[name="answer"]:checked');
          if (!selected) return alert("Please select an answer before continuing.");

          const answer = selected.value;
          const answers = JSON.parse(localStorage.getItem("answers") || "{}");
          answers[q.key] = answer;
          localStorage.setItem("answers", JSON.stringify(answers));

          questionIndex++;
          localStorage.setItem("questionIndex", String(questionIndex));

          // Increment and log each interaction as a visit/progress row
          visitCount = parseInt(localStorage.getItem("visitCount") || "0") + 1;
          localStorage.setItem("visitCount", visitCount);

          const profile = JSON.parse(localStorage.getItem("profileData") || "{}");
          await logVisit(profile, { lastQuestion: q.key, lastAnswer: answer });

          questionContainer.innerHTML = "<p>Thank you for your answer!</p>";
        });
      }

      // Ship a row to Zapier/Sheet
      async function logVisit(profile, extra = {}) {
        const geo = await getGeo();
        const answers = JSON.parse(localStorage.getItem("answers") || "{}");

        const payload = {
          // Identifiers
          UUID: uuid,
          EMAIL: profile?.email || "",
          "FIRST NAME": profile?.firstName || "",
          "LAST NAME": profile?.lastName || "",
          "OPT-IN": !!profile?.optIn,

          // Context
          STORE: store,                         // from ?source mapping
          "FAVORITE STORE": profile?.favoriteStore || "",
          TIMESTAMP: getVancouverTimestamp(),   // local time
          "TOTAL VISITS": visitCount,

          // Geo/IP
          IP: geo.ip, CITY: geo.city, REGION: geo.region, COUNTRY: geo.country,

          // Survey (persisted)
          visitFrequency: answers.visitFrequency || "",
          otherStores: answers.otherStores || "",
          purchaseType: answers.purchaseType || "",
          avgSpend: answers.avgSpend || "",

          // Last interaction (optional)
          ...extra
        };

        // Fire-and-forget
        fetch(webhook, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      }
    })();
  </script>
</body>
</html>
